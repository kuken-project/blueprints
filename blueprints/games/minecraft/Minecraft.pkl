/// # Minecraft: Java Edition Blueprint
///
/// Küken blueprint for deploying Minecraft Java Edition servers using the [itzg/minecraft-server](https://github.com/itzg/docker-minecraft-server) Docker image.
abstract module io.kuken.minecraft.Minecraft

extends "https://kuken.io/blueprints/reference/v1/Reference.pkl"

// ============================================================================
// MINECRAFT SPECIFIC CONFIGURATION
// ============================================================================

/// Configuration for Minecraft server software.
hidden minecraft: Minecraft

local class Minecraft {

  /// The server software implementation to use.
  ///
  /// Specifies which Minecraft server software should be deployed.
  /// See [Types and Platforms](https://docker-minecraft-server.readthedocs.io/en/latest/types-and-platforms/).
  software:  "VANILLA" | "PAPER"
}

// ============================================================================
// INHERITED REFERENCE PROPERTIES
// ============================================================================

author = "Küken <support@kuken.gg>"
url = "https://kuken.io"

assets {
  icon = "https://kuken.io/blueprints/icons/minecraft-java-edition.jpg"
}

// ============================================================================
// INPUT DEFINITIONS
// ============================================================================

/// Docker image tag/version for the Minecraft server container.
local JavaVersion = new SelectInput {
  label = "Java Version"
  items = new Mapping {
    ["stable"]  = "Stable"
    ["java25"]  = "Java 25"
    ["java21"]  = "Java 21"
    ["java17"]  = "Java 17"
    ["java11"]  = "Java 11"
    ["java8"]   = "Java 8"
  }
}
/// Minecraft version to run on the server.
/// Use `"LATEST"` for the newest release, specific versions like `"1.20.4"`, or `"SNAPSHOT"` for testing builds.
local GameVersion = textInput("game-version", "Minecraft Version")

inputs {
  JavaVersion
  GameVersion
}

// ============================================================================
// BUILD CONFIGURATION
// ============================================================================

build {
  docker {
    image = "itzg/minecraft-server:\(JavaVersion)"
  }

  env = new Mapping {
    ["EULA"]                    = true
    ["CREATE_CONSOLE_IN_PIPE"]  = true
    ["TYPE"]                    = minecraft.software
    ["VERSION"]                 = GameVersion
    ["MEMORY"]                  = module.refs.instance.memory
  }
}

// ============================================================================
// INSTANCE SETTINGS
// ============================================================================

instance {
  startup = "java -jar \(module.refs.instance.jarFile)"
  command = ssh("mc-send-to-console \(module.refs.instance.command)")
}