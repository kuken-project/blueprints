amends "https://kuken.io/blueprints/reference/v1/Reference.pkl"

name = "Hytale"
version = "1.0.0"
description = ""
author = "KÃ¼ken <support@kuken.gg>"
url = "https://kuken.io"

assets {
  icon = "https://kuken.io/blueprints/icons/hytale.png"
}

// ============================================================================
// USER-DEFINED INPUT DEFINITIONS
// ============================================================================

local AuthMode = selectInput(
  "Auth Mode",
  new Mapping {
    ["authenticated"] = "Authenticated"
    ["insecure"]      = "Insecure"
    ["offline"]       = "Offline"
  }
)

local AllowOperators = checkboxInput("Allow Server Operators") |> default(true)

/// Hytale warns that loading early plugins is unsupported and may cause stability issues.
local AcceptEarlyPlugins = checkboxInput("Accept Early Plugins")
  |> default(true)
  |> withDescription("Allow loading early or experimental plugins (unsupported and may cause stability issues)")

/// Hytale uses Sentry to track crashes. Disable Sentry during active plugin development.
local DisableSentry = checkboxInput("Disable Sentry")
  |> withDescription("Hytale uses Sentry to track crashes. Disable Sentry during active plugin development.")

/// Installs the Soruce Query plugin, so that your server responds to
/// Source Query A2S requests (player count, server name, etc.).
local InstallSourceQueryPlugin = checkboxInput("Install Source Query plugin")
  |> default(true)
  |> withDescription("Installs the Soruce Query plugin, so that your server responds to Source Query A2S requests (player count, server name, etc.).")

/// The port that the Source Query plugin will use to respond to A2S requests.
/// This should be different from the main server port. Defaults to the game port + 1.
local SourceQueryPort = portInput("Source Query Port")
  |> withDescription(
      """
      The port that the Source Query plugin will use to respond to A2S requests.
      This should be different from the main server port. Defaults to the game port + 1.
      """
    )

/// Hytale provides a pre-trained AOT Java cache which can significantly improve boot times.
local UseAOTCache = checkboxInput("Use AOT Cache")
  |> default(true)
  |> withDescription("Hytale provides a pre-trained AOT Java cache which can significantly improve boot times.")

inputs {
  AcceptEarlyPlugins
  AllowOperators
  AuthMode
  DisableSentry
  InstallSourceQueryPlugin
  SourceQueryPort
  UseAOTCache
}

// ============================================================================
// BUILD CONFIGURATION
// ============================================================================

build {
  defaultPort = portRange(1, 65535)

  docker {
    image = "deinfreu/hytale-server:staging-alpine-liberica"
  }

  env = new Mapping {
    ["HYTALE_AUTH_MODE"]            = AuthMode
    ["HYTALE_ACCEPT_EARLY_PLUGINS"] = AcceptEarlyPlugins
    ["DISABLE_SENTRY"]              = DisableSentry
    ["USE_AOT_CACHE"]               = UseAOTCache
    ["HYTALE_ALLOW_OP"]             = AllowOperators
    ["INSTALL_SOURCEQUERY_PLUGIN"]  = InstallSourceQueryPlugin
    ["QUERY_PORT"]                  = SourceQueryPort
    ["SERVER_IP"]                   = module.refs.network.host
    ["SERVER_PORT"]                 = module.refs.network.port
  }
}

// ============================================================================
// INSTANCE SETTINGS
// ============================================================================

instance {
  startup =
    """
    java -Xms128 --assets Assets.zip --bind 0.0.0.0:\(module.refs.network.port) -jar Server/HytaleServer.jar
    """
}
